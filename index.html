<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ©Ÿç”²å……èƒ½ç«™ v3.5 (é‡Œç¨‹ç¢‘ç‰ˆ)</title>
    <style>
        :root {
            --primary: #00d2d3;
            --hp-red: #ff4757;
            --group-bg: rgba(255, 255, 255, 0.2);
            --infinite-blue: #54a0ff;
            --infinite-purple: #a29bfe;
        }

        * { 
            box-sizing: border-box; 
            user-select: none; -webkit-user-select: none; 
            touch-action: manipulation;
        }

        body {
            font-family: "Segoe UI", Roboto, sans-serif;
            background-color: #2f3640;
            margin: 0;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; min-height: 100dvh;
            position: fixed; width: 100%; height: 100%;
        }

        .battle-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2; background-size: cover; background-position: center; opacity: 0.5;
            pointer-events: none;
        }

        .container {
            width: 100%; max-width: 600px;
            height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: space-between;
            padding: 10px 20px max(20px, env(safe-area-inset-bottom));
            position: relative;
        }

        /* HUD */
        .hud {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            color: white; font-size: 1.1rem; font-weight: bold;
            text-shadow: 0 0 5px var(--primary);
            z-index: 10; margin-top: 5px;
            background: rgba(0,0,0,0.4); border-radius: 15px; padding: 5px 15px;
        }
        
        .icon-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);
            color: white; border-radius: 8px; cursor: pointer;
            padding: 5px 10px; font-size: 1.2rem; transition: background 0.2s;
            margin-left: 5px;
        }

        .energy-container {
            width: 100%; height: 20px; background: #333;
            border: 2px solid #fff; border-radius: 10px;
            margin-top: 10px; position: relative; overflow: hidden;
        }
        .energy-bar {
            width: 0%; height: 100%; background: linear-gradient(90deg, #f1c40f, #2ed573);
            transition: width 0.3s ease-out;
        }

        .progress-text {
            color: #feca57; font-weight: bold; margin-top: 5px; font-size: 1.1rem;
            text-shadow: 0 2px 2px rgba(0,0,0,0.5);
        }

        .question-zone {
            flex: 1; width: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            position: relative;
        }

        #hero-img {
            max-height: 20vh; width: auto; object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(0,210,211,0.5));
            transition: transform 0.2s;
        }
        .hero-shoot { animation: shootRecoil 0.2s; filter: drop-shadow(0 0 20px #fff) !important; }
        @keyframes shootRecoil { 0% { transform: scale(1); } 50% { transform: scale(0.9); } 100% { transform: scale(1); } }

        .math-display {
            font-size: 4rem; font-weight: 900; color: #fff;
            text-shadow: 0 5px 0 #222, 0 0 20px var(--primary);
            margin: 5px 0; letter-spacing: 2px;
            display: flex; align-items: center; gap: 15px;
        }
        .operator { color: #feca57; }

        .visual-aid {
            display: flex; gap: 20px; min-height: 60px;
            justify-content: center; align-items: flex-start;
            margin-bottom: 10px; width: 100%;
        }
        
        .ten-frame-group {
            display: flex; flex-wrap: wrap; width: auto; max-width: 140px; 
            gap: 4px; padding: 4px; background: var(--group-bg);
            border-radius: 8px; justify-content: center;
        }
        
        .math-icon {
            width: 24px; height: 24px; background-color: #00d2d3;
            border-radius: 4px; box-shadow: 0 0 8px #00d2d3; background-size: cover;
        }
        .icon-img {
            background-image: url('energy.png'); background-color: transparent; 
            box-shadow: none; width: 26px; height: 26px;
        }
        .math-icon.sec { background-color: #ff9ff3; box-shadow: 0 0 8px #ff9ff3; }
        .icon-img.sec { filter: hue-rotate(90deg); background-color: transparent; box-shadow: none; }

        @media (max-width: 400px) {
            .math-icon { width: 18px; height: 18px; }
            .icon-img { width: 20px; height: 20px; }
            .ten-frame-group { max-width: 110px; }
            .math-display { font-size: 3rem; }
        }

        .count-on-hint {
            font-size: 2rem; color: #fff; font-weight: bold;
            border: 3px solid #00d2d3; border-radius: 12px;
            background: rgba(0, 210, 211, 0.2);
            padding: 0 20px; height: 60px; line-height: 54px;
            animation: pulseText 1.5s infinite;
        }
        @keyframes pulseText {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,210,211,0); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(0,210,211,0.6); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,210,211,0); }
        }

        #boom-img {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 250px; max-width: 90%; z-index: 30; opacity: 0; pointer-events: none;
        }
        .boom-anim { animation: boomPop 1.2s forwards; }
        @keyframes boomPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1.0); }
            70% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        .options-grid {
            width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            margin-bottom: 20px;
        }
        .ans-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 4px solid #fff; border-bottom: 8px solid #ccc;
            border-radius: 20px;
            font-size: 2.2rem; font-weight: bold; color: #333;
            padding: 20px; cursor: pointer;
            transition: all 0.1s;
            display: flex; justify-content: center; align-items: center;
        }
        .ans-btn:active { transform: translateY(4px); border-bottom: 4px solid #ccc; background: #ddd; }

        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100; color: white; text-align: center;
            padding: 20px;
        }
        .menu-btn {
            background: transparent; border: 2px solid var(--primary);
            color: white; padding: 15px 30px; margin: 10px;
            font-size: 1.3rem; border-radius: 50px; cursor: pointer;
            width: 100%; max-width: 350px; transition: all 0.2s;
        }
        .menu-btn:active { background: var(--primary); color: black; transform: scale(0.95); }
        .level-tag { font-size: 0.9rem; opacity: 0.8; display: block; margin-top: 5px; color: #ffeb3b; }
        .hidden { display: none !important; }
        
        #rest-screen { background: rgba(0,0,0,1); z-index: 200; }

        .menu-btn.infinite-add { border-color: var(--infinite-blue); }
        .menu-btn.infinite-add:active { background: var(--infinite-blue); }
        
        .menu-btn.infinite-sub { border-color: var(--infinite-purple); }
        .menu-btn.infinite-sub:active { background: var(--infinite-purple); }

        /* é‡Œç¨‹ç¢‘ç•«é¢æ¨£å¼ */
        #milestone-screen {
            background: rgba(0,0,0,0.85);
            z-index: 150;
        }
        .milestone-text {
            font-size: 2.5rem; color: #f1c40f;
            text-shadow: 0 0 20px rgba(241, 196, 15, 0.5);
            margin-bottom: 20px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <div class="battle-bg" style="background-image: url('bg.png');"></div>

    <div class="container">
        <div class="hud">
            <div style="display: flex; align-items: center;">
                <button class="icon-btn" onclick="backToMode()">â® é¸å–®</button>
                <button class="icon-btn" id="voice-btn" onclick="toggleVoice()">ğŸ—£ï¸</button>
            </div>
            <div style="display: flex; align-items: center;">
                <span>Score: <span id="score-display">0</span></span>
                <button class="icon-btn" onclick="togglePause()">â¸</button>
            </div>
        </div>

        <div class="energy-container">
            <div class="energy-bar" id="energy-bar"></div>
        </div>
        <div id="progress-text" class="progress-text">é€²åº¦: 0 / 10</div>

        <div class="question-zone">
            <img id="boom-img" src="boom.png">
            <img id="hero-img" src="hero.png">
            
            <div class="math-display">
                <span id="num1">5</span>
                <span class="operator" id="operator">+</span>
                <span id="num2">3</span>
                <span class="operator">=</span>
                <span class="operator">?</span>
            </div>

            <div class="visual-aid" id="visual-aid"></div>
        </div>

        <div class="options-grid" id="options-box"></div>
    </div>

    <div id="mode-screen" class="overlay-screen">
        <h1 style="color: var(--primary);">æ©Ÿç”²å……èƒ½ç«™</h1>
        <p>åª½åª½è‡ªè£½ï¼šé˜²æˆç™®å¿ƒç®—ç‰¹è¨“</p>
        
        <button class="menu-btn" onclick="startGame(1)">
            ğŸŸ¢ Lv1 åˆç´šå……èƒ½
            <span class="level-tag">ç›®æ¨™ 10 é¡Œ (10ä»¥å…§åŠ æ³•)</span>
        </button>
        <button class="menu-btn" onclick="startGame(2)">
            ğŸŸ¡ Lv2 é€²éšå……èƒ½
            <span class="level-tag">ç›®æ¨™ 15 é¡Œ (20ä»¥å…§åŠ æ¸›)</span>
        </button>
        <button class="menu-btn" onclick="startGame(3)">
            ğŸ”´ Lv3 æ¥µé€Ÿé‹è½‰
            <span class="level-tag">ç›®æ¨™ 25 é¡Œ (100ä»¥å…§åŠ æ¸›)</span>
        </button>
        
        <div style="display: flex; gap: 10px; width: 100%; max-width: 350px;">
            <button class="menu-btn infinite-add" style="flex:1; margin: 10px 0;" onclick="startGame('infinite-add')">
                â™¾ï¸ ç´”åŠ æ³•
                <span class="level-tag" style="color: var(--infinite-blue);">è‡ªç”±ç·´</span>
            </button>
            <button class="menu-btn infinite-sub" style="flex:1; margin: 10px 0;" onclick="startGame('infinite-sub')">
                â™¾ï¸ ç´”æ¸›æ³•
                <span class="level-tag" style="color: var(--infinite-purple);">è‡ªç”±ç·´</span>
            </button>
        </div>
    </div>

    <div id="pause-screen" class="overlay-screen hidden">
        <h1>å·²æš«åœ</h1>
        <button class="menu-btn" onclick="togglePause()">â–¶ ç¹¼çºŒ</button>
        <button class="menu-btn" onclick="backToMode()">â® å›é¸å–®</button>
    </div>

    <div id="levelup-screen" class="overlay-screen hidden">
        <h1 style="color: #f1c40f;">ğŸ‰ å……èƒ½å®Œæˆï¼</h1>
        <img src="hero.png" style="width: 150px; filter: drop-shadow(0 0 20px gold);">
        <p>æ©Ÿç”²èƒ½é‡å·²å……æ»¿ï¼</p>
        <button class="menu-btn" onclick="goToNextLevel()">ğŸš€ å‰å¾€ä¸‹ä¸€é—œ</button>
    </div>

    <div id="victory-screen" class="overlay-screen hidden">
        <h1 style="color: #2ed573;">ğŸ‰ ä»»å‹™å…¨æ•¸å®Œæˆï¼</h1>
        <div style="font-size: 5rem;">ğŸ‘‘</div>
        <p style="font-size: 1.2rem;">å¤ªå²å®³äº†ï¼ä½ å®Œæˆäº†æ‰€æœ‰ç‰¹è¨“ï¼</p>
        <p>æœ€çµ‚å¾—åˆ†: <span id="victory-score" style="color:#f1c40f">0</span></p>
        <button class="menu-btn" onclick="backToMode()">â® å›åˆ°é¦–é </button>
    </div>

    <div id="result-screen" class="overlay-screen hidden">
        <h1 style="color: #ff4757;">èƒ½é‡è€—ç›¡</h1>
        <img src="lose.png" style="width: 120px; margin: 10px 0;">
        <p style="font-size: 1.5rem;">å¾—åˆ†: <span id="final-score" style="color:var(--primary)">0</span></p>
        <button class="menu-btn" onclick="restartLevel()">ğŸ”„ å†è©¦ä¸€æ¬¡</button>
    </div>

    <div id="milestone-screen" class="overlay-screen hidden">
        <h1 class="milestone-text">ğŸ‰ é”æˆç›®æ¨™ï¼</h1>
        <img src="hero.png" style="width: 180px; filter: drop-shadow(0 0 30px var(--primary));">
        <p style="font-size: 1.5rem; margin-top: 20px;">å·²å®Œæˆ <span id="milestone-count" style="color: #feca57; font-size: 2rem;">10</span> é¡Œ</p>
        <p style="color: #aaa; font-size: 0.9rem;">(ä¼‘æ¯ä¸€ä¸‹ï¼Œé¦¬ä¸Šç¹¼çºŒ...)</p>
    </div>

    <div id="rest-screen" class="overlay-screen hidden">
        <div style="font-size: 3rem;">ğŸ‘€</div>
        <h1>çœ¼ç›ä¼‘æ¯æ™‚é–“</h1>
        <p>å·²ç¶“ç‰¹è¨“ 15 åˆ†é˜å›‰ï¼</p>
        <p>æ©Ÿç”²éœ€è¦å†·å»ï¼Œè«‹è®“çœ¼ç›ä¼‘æ¯ä¸€ä¸‹ã€‚</p>
        <p style="color: #666; font-size: 0.8rem; margin-top:20px;">(è«‹é—œé–‰ç¶²é ï¼Œç¨å¾Œå†ä¾†)</p>
    </div>

    <script>
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        let voiceEnabled = true;

        // é˜²ç¸®æ”¾
        document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
        document.addEventListener('dblclick', function(e) { e.preventDefault(); }, { passive: false });

        // å…¨åŸŸé»æ“Šå–šé†’éŸ³æ•ˆ
        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        document.body.addEventListener('click', function() { initAudio(); }, { once: true });
        document.body.addEventListener('touchstart', function() { initAudio(); }, { once: true });

        // é—œå¡ç›®æ¨™
        const LEVEL_TARGETS = { 1: 10, 2: 15, 3: 25 };

        let totalTimePlayed = 0;
        setInterval(() => {
            totalTimePlayed++;
            if(totalTimePlayed >= 900) {
                document.getElementById('rest-screen').classList.remove('hidden');
                state.isPlaying = false;
                if(state.timer) clearInterval(state.timer);
            }
        }, 1000);

        function playSound(type) {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            if(type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
            } else if(type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
            } else if(type === 'levelup') {
                playArpeggio([523, 659, 784, 1046]); speakText("è€¶ï¼ä½ å¥½æ£’å–”ï¼"); return;
            } else if(type === 'victory') {
                playArpeggio([523, 523, 523, 659, 784, 1046, 1318], 0.15); return;
            } else if(type === 'gameover') {
                playSlideDown(); return;
            }
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }

        function playArpeggio(notes, speed = 0.1) {
            if (!audioCtx) initAudio();
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = 'square'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * speed);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime + i * speed); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + i * speed + speed);
                osc.connect(gain); gain.connect(audioCtx.destination); osc.start(audioCtx.currentTime + i * speed); osc.stop(audioCtx.currentTime + i * speed + speed);
            });
        }

        function playSlideDown() {
            if (!audioCtx) initAudio();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.8);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.8);
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.8);
        }

        function speakText(text) {
            if(!voiceEnabled || !window.speechSynthesis) return;
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW'; utterance.rate = 1; utterance.pitch = 1.4;
                window.speechSynthesis.speak(utterance);
            }, 500);
        }

        function speakQuestion(n1, op, n2) {
            if(!voiceEnabled || !window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            let opText = (op === '+') ? "åŠ " : "æ¸›";
            let text = (state.level === 2) ? `${n1} ...... ${opText} ${n2}` : `${n1} ${opText} ${n2}`;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW'; utterance.rate = 0.8; utterance.pitch = 1.2;
            window.speechSynthesis.speak(utterance);
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            document.getElementById('voice-btn').innerText = voiceEnabled ? 'ğŸ—£ï¸' : 'ğŸ”‡';
        }

        let state = { level: 1, score: 0, energy: 50, answer: 0, isPlaying: false, isPaused: false, levelProgress: 0, gameMode: 'normal', infiniteCount: 0 };

        const els = {
            num1: document.getElementById('num1'), num2: document.getElementById('num2'), op: document.getElementById('operator'),
            visual: document.getElementById('visual-aid'), options: document.getElementById('options-box'),
            energyBar: document.getElementById('energy-bar'), score: document.getElementById('score-display'),
            hero: document.getElementById('hero-img'), boom: document.getElementById('boom-img'),
            progressText: document.getElementById('progress-text'),
            screens: { 
                mode: document.getElementById('mode-screen'), result: document.getElementById('result-screen'),
                levelup: document.getElementById('levelup-screen'), victory: document.getElementById('victory-screen'),
                pause: document.getElementById('pause-screen'), milestone: document.getElementById('milestone-screen')
            }
        };

        function startGame(lv) {
            initAudio();
            
            // æ¨¡å¼åˆ¤æ–·
            if (lv === 'infinite-add') {
                state.gameMode = 'infinite-add';
                state.level = 1; 
            } else if (lv === 'infinite-sub') {
                state.gameMode = 'infinite-sub';
                state.level = 1; 
            } else {
                state.gameMode = 'normal';
                state.level = lv;
            }

            state.score = 0;
            state.energy = 50; 
            state.levelProgress = 0;
            state.infiniteCount = 0; // ç„¡é™æ¨¡å¼è¨ˆæ•¸å™¨
            state.isPlaying = true;
            state.isPaused = false;
            
            Object.values(els.screens).forEach(el => el.classList.add('hidden'));
            
            updateUI();
            nextQuestion();
            
            if(state.timer) clearInterval(state.timer);
            
            let dropRate = (state.gameMode.startsWith('infinite')) ? 0 : (lv === 1 ? 0 : (lv === 2 ? 0.3 : 0.8));
            
            if(dropRate > 0) {
                state.timer = setInterval(() => {
                    if(!state.isPlaying || state.isPaused) return;
                    state.energy -= dropRate;
                    if(state.energy <= 0) gameOver();
                    updateUI();
                }, 500);
            }
        }

        function togglePause() {
            if(!state.isPlaying) return;
            state.isPaused = !state.isPaused;
            if(state.isPaused) els.screens.pause.classList.remove('hidden');
            else els.screens.pause.classList.add('hidden');
        }

        function updateUI() {
            if(state.energy > 100) state.energy = 100;
            if(state.energy < 0) state.energy = 0;
            els.energyBar.style.width = state.energy + '%';
            if(state.energy < 30) els.energyBar.style.background = '#ff4757';
            else els.energyBar.style.background = 'linear-gradient(90deg, #f1c40f, #2ed573)';

            if (state.gameMode.startsWith('infinite')) {
                els.progressText.innerText = `å·²å®Œæˆ: ${state.infiniteCount} é¡Œ`;
                els.progressText.style.color = (state.gameMode === 'infinite-add') ? '#54a0ff' : '#a29bfe';
            } else {
                let target = LEVEL_TARGETS[state.level];
                els.progressText.innerText = `é€²åº¦: ${state.levelProgress} / ${target}`;
                els.progressText.style.color = '#feca57';
            }
        }

        function nextQuestion() {
            if(!state.isPlaying || state.isPaused) return;

            let n1, n2, op;
            
            if (state.gameMode === 'infinite-add') {
                // ç„¡é™åŠ æ³•
                op = '+';
                if(Math.random() > 0.4) {
                    n1 = Math.floor(Math.random() * 9) + 2; n2 = Math.floor(Math.random() * 8) + 1;
                } else {
                    n1 = Math.floor(Math.random() * 5) + 1; n2 = Math.floor(Math.random() * 5) + 1; 
                }
            } else if (state.gameMode === 'infinite-sub') {
                // ç„¡é™æ¸›æ³•
                op = '-';
                if(Math.random() > 0.4) {
                    n1 = Math.floor(Math.random() * 12) + 3; n2 = Math.floor(Math.random() * (n1-2)) + 1;
                } else {
                    n1 = Math.floor(Math.random() * 5) + 2; n2 = Math.floor(Math.random() * (n1-1)) + 1; 
                }
            } else {
                // åŸæœ‰é—–é—œé‚è¼¯
                if(state.level === 1) {
                    op = '+'; n1 = Math.floor(Math.random() * 5) + 1; n2 = Math.floor(Math.random() * 5) + 1; 
                } else if(state.level === 2) {
                    op = Math.random() > 0.8 ? '-' : '+';
                    if(op === '+') { n1 = Math.floor(Math.random() * 9) + 3; n2 = Math.floor(Math.random() * 5) + 1; } 
                    else { n1 = Math.floor(Math.random() * 8) + 3; n2 = Math.floor(Math.random() * (n1-1)) + 1; }
                } else {
                    op = Math.random() > 0.5 ? '-' : '+';
                    if(op === '+') { n1 = Math.floor(Math.random() * 50) + 10; n2 = Math.floor(Math.random() * 40) + 5; } 
                    else { n1 = Math.floor(Math.random() * 80) + 20; n2 = Math.floor(Math.random() * (n1 - 10)) + 5; }
                }
            }

            state.answer = (op === '+') ? n1 + n2 : n1 - n2;
            els.num1.innerText = n1; els.num2.innerText = n2; els.op.innerText = op;

            renderVisuals(n1, n2, op);
            generateOptions(state.answer);
            speakQuestion(n1, op, n2);
        }

        function renderVisuals(n1, n2, op) {
            els.visual.innerHTML = '';
            if(state.level === 3 && !state.gameMode.startsWith('infinite')) return; 

            const imgClass = 'math-icon icon-img'; 
            function createDots(count, isSecondary = false) {
                const container = document.createElement('div');
                container.style.display = 'flex'; container.style.gap = '5px';
                let dotsLeft = count;
                while(dotsLeft > 0) {
                    const group = document.createElement('div'); group.className = 'ten-frame-group';
                    let groupCount = Math.min(5, dotsLeft);
                    for(let i=0; i<groupCount; i++) {
                        const dot = document.createElement('div');
                        dot.className = isSecondary ? `${imgClass} sec` : imgClass;
                        group.appendChild(dot);
                    }
                    container.appendChild(group); dotsLeft -= groupCount;
                }
                return container;
            }
            els.visual.appendChild(createDots(n1, false)); 
            const opSign = document.createElement('div'); opSign.innerText = op; opSign.style.color = '#aaa';
            els.visual.appendChild(opSign);
            els.visual.appendChild(createDots(n2, true)); 
        }

        function generateOptions(correct) {
            els.options.innerHTML = '';
            let opts = new Set(); opts.add(correct);
            let range = (state.level === 3 && !state.gameMode.startsWith('infinite')) ? 10 : 3; 

            while(opts.size < 4) {
                let fake = correct + Math.floor(Math.random() * (range*2 + 1)) - range;
                if(fake >= 0 && fake !== correct) opts.add(fake);
            }
            let optsArr = Array.from(opts).sort(() => Math.random() - 0.5);
            optsArr.forEach(val => {
                const btn = document.createElement('div'); btn.className = 'ans-btn'; btn.innerText = val;
                btn.addEventListener('pointerdown', () => checkAnswer(val));
                els.options.appendChild(btn);
            });
        }

        function checkAnswer(val) {
            if(!state.isPlaying || state.isPaused) return;

            if(val === state.answer) {
                playSound('correct');
                state.score += 100;
                state.energy += (state.level === 1 || state.gameMode.startsWith('infinite') ? 15 : 10);
                state.levelProgress++;
                if (state.gameMode.startsWith('infinite')) state.infiniteCount++;
                
                els.score.innerText = state.score;
                updateUI();
                els.hero.classList.add('hero-shoot');
                setTimeout(() => els.hero.classList.remove('hero-shoot'), 200);

                if (state.gameMode.startsWith('infinite')) {
                    // é‡Œç¨‹ç¢‘æª¢æŸ¥ (æ¯10é¡Œ)
                    if (state.infiniteCount % 10 === 0) {
                        showMilestone();
                    } else {
                        nextQuestion();
                    }
                } else {
                    let target = LEVEL_TARGETS[state.level];
                    if(state.levelProgress >= target) {
                        if(state.level < 3) showLevelUp(); else showVictory();
                    } else {
                        nextQuestion();
                    }
                }
            } else {
                playSound('wrong');
                state.energy -= 20;
                updateUI();
                els.boom.classList.remove('boom-anim'); void els.boom.offsetWidth; els.boom.classList.add('boom-anim');
                if(state.energy <= 0) gameOver();
            }
        }

        function showMilestone() {
            // æš«æ™‚åœæ­¢äº’å‹•
            els.options.innerHTML = ''; 
            playSound('levelup');
            document.getElementById('milestone-count').innerText = state.infiniteCount;
            els.screens.milestone.classList.remove('hidden');
            
            // 3ç§’å¾Œè‡ªå‹•ç¹¼çºŒ
            setTimeout(() => {
                if (state.isPlaying) {
                    els.screens.milestone.classList.add('hidden');
                    nextQuestion();
                }
            }, 3000);
        }

        function showLevelUp() { state.isPlaying = false; playSound('levelup'); els.screens.levelup.classList.remove('hidden'); }
        function showVictory() { state.isPlaying = false; document.getElementById('victory-score').innerText = state.score; playSound('victory'); els.screens.victory.classList.remove('hidden'); }
        function goToNextLevel() { state.level++; startGame(state.level); }
        function restartLevel() { 
            if(state.gameMode.startsWith('infinite')) startGame(state.gameMode);
            else startGame(state.level);
        }
        function gameOver() { state.isPlaying = false; clearInterval(state.timer); playSound('gameover'); els.screens.result.classList.remove('hidden'); document.getElementById('final-score').innerText = state.score; }
        function backToMode() { state.isPlaying = false; clearInterval(state.timer); Object.values(els.screens).forEach(el => el.classList.add('hidden')); els.screens.mode.classList.remove('hidden'); }
    </script>
</body>
</html>